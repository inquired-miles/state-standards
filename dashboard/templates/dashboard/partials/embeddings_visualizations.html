<div class="control-panel {% if simple_mode %}d-none{% endif %}" id="embeddings-control-panel">
    <h5 class="mb-3"><i class="fas fa-sliders-h"></i> Grouping Controls</h5>
    
    <form id="controls-form" class="row g-3">
        <div class="col-md-2">
            <label for="grade-level" class="form-label">
                <i class="fas fa-graduation-cap"></i> Grade Level
            </label>
            <select id="grade-level" class="form-select">
                <option value="">All Grades</option>
                {% for grade in grade_levels %}
                <option value="{{ grade.grade_numeric }}">{{ grade.grade }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="subject-area" class="form-label">
                <i class="fas fa-book-open"></i> Subject Area
            </label>
            <select id="subject-area" class="form-select">
                <option value="">All Subjects</option>
                {% for subject in subject_areas %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="cluster-size" class="form-label">
                <i class="fas fa-layer-group"></i> Number of Groups
            </label>
            <input type="range" class="form-range" id="cluster-size" min="2" max="30" value="5">
            <div class="d-flex justify-content-between small text-muted">
                <span>Broad (2)</span>
                <span id="cluster-size-value" class="fw-bold">5</span>
                <span>Specific (30)</span>
            </div>
        </div>
        <div class="col-md-3">
            <label for="epsilon" class="form-label">
                <i class="fas fa-bullseye"></i> Strictness
            </label>
            <input type="range" class="form-range" id="epsilon" min="0.05" max="1.0" step="0.05" value="0.5">
            <div class="d-flex justify-content-between small text-muted">
                <span>Precise</span>
                <span id="epsilon-value" class="fw-bold">0.5</span>
                <span>Flexible</span>
            </div>
        </div>

        <div class="col-md-2">
            <label for="viz-mode" class="form-label">
                <i class="fas fa-cube"></i> View Mode
            </label>
            <select id="viz-mode" class="form-select">
                <option value="2d">2D Scatter</option>
                <option value="3d">3D Scatter</option>
            </select>
        </div>
    </form>

    <div class="row mt-3">
        <div class="col-md-8">
            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advanced-controls" aria-expanded="false">
                <i class="fas fa-cogs"></i> Advanced Settings
            </button>
        </div>
        <div class="col-md-4 text-end">
            <button type="button" id="update-viz" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Update Groups
            </button>
        </div>
    </div>

    <div class="collapse mt-3" id="advanced-controls">
        <div class="card card-body">
            <h6 class="mb-3">Advanced Parameters</h6>
            <div class="row g3">
                <div class="col-md-3">
                    <label for="n-neighbors" class="form-label">
                        <i class="fas fa-users"></i> Neighborhood Size
                    </label>
                    <input type="range" class="form-range" id="n-neighbors" min="5" max="50" value="15">
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Local (5)</span>
                        <span id="n-neighbors-value" class="fw-bold">15</span>
                        <span>Global (50)</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="clustering-method" class="form-label">
                        <i class="fas fa-project-diagram"></i> Clustering Method
                    </label>
                    <select id="clustering-method" class="form-select">
                        <option value="hdbscan">Smart Density (Recommended)</option>
                        <option value="similarity">Simple Similarity</option>
                        <option value="hierarchical">Hierarchical Tree</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="subject-focus" class="form-label">
                        <i class="fas fa-balance-scale"></i> Subject Focus
                    </label>
                    <select id="subject-focus" class="form-select">
                        <option value="mixed">Mixed Subjects (Default)</option>
                        <option value="prefer-same">Prefer Same Subject</option>
                        <option value="separate-subjects">Separate by Subject</option>
                    </select>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="max-standards" class="form-label">Max Standards</label>
                    <input type="number" class="form-control" id="max-standards" value="500" min="100" max="2000">
                </div>
                <div class="col-md-3">
                    <label for="standards-per-cluster" class="form-label">Standards per Cluster</label>
                    <input type="number" class="form-control" id="standards-per-cluster" value="25" min="5" max="100">
                </div>
                <div class="col-md-3">
                    <label for="secondary-threshold" class="form-label">Secondary Link Threshold</label>
                    <input type="number" class="form-control" id="secondary-threshold" value="0.5" step="0.05" min="0" max="1">
                </div>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs" id="viz-tabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="scatter-tab" data-bs-toggle="tab" data-bs-target="#scatter-pane" type="button" role="tab">
            üìç Concept Groups
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="heatmap-tab" data-bs-toggle="tab" data-bs-target="#heatmap-pane" type="button" role="tab">
            Similarity Maps
        </button>
    </li>
    {% if not simple_mode %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane" type="button" role="tab">
            Find Related Standards
        </button>
    </li>
    {% endif %}
</ul>

<div class="tab-content" id="viz-tab-content">
    <div class="tab-pane fade show active" id="scatter-pane" role="tabpanel">
        <div class="visualization-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">üìä Topic Clusters</h5>
                <span id="scatter-info" class="text-muted">Loading...</span>
            </div>
            <div class="position-relative">
                <div id="scatter-plot" class="scatter-plot"></div>
                <div id="scatter-loading" class="loading-overlay d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
            <div class="alert alert-info py-2 mb-3">
                <small><strong>Interpretation:</strong> Dots closer together have more similar context. Distinct groups represent different concepts or subject.</small>
            </div>
            <div id="cluster-info" class="mt-3"></div>
        </div>
    </div>

    <div class="tab-pane fade" id="heatmap-pane" role="tabpanel">
        <div class="visualization-container">
            <div class="row mb-3">
                <div class="col-md-8">
                    <h5 class="mb-0">
                        <span id="heatmap-title">üìä Topic Coverage Heat Map</span>
                        <small class="text-muted ms-2" id="heatmap-subtitle">Topic clusters √ó states coverage analysis</small>
                        <span class="ms-2 text-muted small" id="heatmap-info"></span>
                    </h5>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadHeatMapData('topic')">Topic Coverage</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadHeatMapData('enhanced_state')">Enhanced State</button>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label" for="heatmap-type">Heat Map Type</label>
                    <select id="heatmap-type" class="form-select">
                        <option value="topic">Topic Coverage</option>
                        <option value="enhanced_state">Enhanced State Coverage</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label" for="heatmap-colorscheme">Color Scheme</label>
                    <select id="heatmap-colorscheme" class="form-select">
                        <option value="Blues">Blues</option>
                        <option value="Greens">Greens</option>
                        <option value="Reds">Reds</option>
                        <option value="Viridis">Viridis</option>
                        <option value="Plasma">Plasma</option>
                    </select>
                </div>
            </div>
            <div class="position-relative">
                <div id="heatmap" class="heatmap"></div>
                <div id="heatmap-loading" class="loading-overlay d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
            <div id="heatmap-description" class="mt-2"></div>
            <div id="heatmap-stats" class="mt-3"></div>
        </div>
    </div>

    {% if not simple_mode %}
    <div class="tab-pane fade" id="search-pane" role="tabpanel">
        <div class="visualization-container">
            {% include 'dashboard/partials/semantic_search.html' with title='Find Standards by Topics, Concepts, and more' enable_selection=False mode='view' %}
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="clustering-help" tabindex="-1" aria-labelledby="clustering-help-label" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clustering-help-label">
                    <i class="fas fa-graduation-cap text-primary"></i> Educational Standards Clustering Guide
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="accordion" id="help-accordion">
                    <!-- accordion content omitted for brevity -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="applyPreset('broad-overview')" data-bs-dismiss="modal">
                    <i class="fas fa-play"></i> Try Broad Overview
                </button>
            </div>
        </div>
    </div>
</div>
