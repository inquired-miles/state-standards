{% extends "dashboard/base.html" %}

{% block title %}Proxy Standards · Dashboard{% endblock %}

{% block content %}
<div class="dashboard-header">
  <div class="container">
    <h1 class="display-6 mb-0">{{ title }}</h1>
    <p class="mb-0">{{ subtitle }}</p>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-8">
      <div class="alert alert-info mb-4" role="alert">
        <h5 class="mb-2">What this does</h5>
        <p class="mb-2">This tool groups very similar learning goals from many states into one shared “Common Standard.” Use it to see the overlap across states and plan content once for many places.</p>
        <ul class="mb-2">
          <li><strong>Min group size</strong>: The smallest number of learning goals needed to form a group. Higher = fewer, bigger groups. Lower = more, smaller groups.</li>
          <li><strong>Merge sensitivity (epsilon)</strong>: How willing the tool is to combine nearby groups. Higher merges more; lower keeps groups separate. Try 0.10–0.25 (default 0.15).</li>
        </ul>
        <p class="mb-0"><strong>What you get</strong>: A list of Common Standards. Each has a representative example, the full list of member learning goals, and how many states it covers. Re‑running safely refreshes existing results. Tip: run “Prepare Data” first so there’s material to group.</p>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Create Common Standards</h5>
          <form id="proxy-form" class="row g-3">
            <!-- Clustering Type Selection -->
            <div class="col-12">
              <label class="form-label">Clustering Type</label>
              <div class="row g-2">
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input clustering-type-radio" type="radio" name="clusteringType" id="clusterAtoms" value="atoms" checked>
                    <label class="form-check-label" for="clusterAtoms">
                      <strong>Cluster by Atoms</strong><br>
                      <small class="text-muted">Groups individual learning objectives (StandardAtoms) from parsed standards</small>
                    </label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input clustering-type-radio" type="radio" name="clusteringType" id="clusterStandards" value="standards">
                    <label class="form-check-label" for="clusterStandards">
                      <strong>Cluster by Standards</strong><br>
                      <small class="text-muted">Groups complete educational standards as whole units</small>
                    </label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input clustering-type-radio" type="radio" name="clusteringType" id="clusterTopics" value="topics">
                    <label class="form-check-label" for="clusterTopics">
                      <strong>Categorize by Topics</strong><br>
                      <small class="text-muted">Uses AI to organize standards into educational topic hierarchies</small>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Grade Level Selection -->
            <div class="col-12">
              <label class="form-label">Grade Level Selection</label>
              <div class="row g-2">
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input grade-type-radio" type="radio" name="gradeSelectionType" id="allGrades" value="all" checked>
                    <label class="form-check-label" for="allGrades">All Grades</label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input grade-type-radio" type="radio" name="gradeSelectionType" id="specificGrades" value="specific">
                    <label class="form-check-label" for="specificGrades">Specific Grades</label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input grade-type-radio" type="radio" name="gradeSelectionType" id="gradeRange" value="range">
                    <label class="form-check-label" for="gradeRange">Grade Range</label>
                  </div>
                </div>
              </div>
              
              <!-- Specific Grades Selection -->
              <div id="specificGradesSection" class="mt-3" style="display: none;">
                <div class="row g-2">
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="0" id="grade_k"><label class="form-check-label ms-1" for="grade_k">K</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="1" id="grade_1"><label class="form-check-label ms-1" for="grade_1">1</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="2" id="grade_2"><label class="form-check-label ms-1" for="grade_2">2</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="3" id="grade_3"><label class="form-check-label ms-1" for="grade_3">3</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="4" id="grade_4"><label class="form-check-label ms-1" for="grade_4">4</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="5" id="grade_5"><label class="form-check-label ms-1" for="grade_5">5</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="6" id="grade_6"><label class="form-check-label ms-1" for="grade_6">6</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="7" id="grade_7"><label class="form-check-label ms-1" for="grade_7">7</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="8" id="grade_8"><label class="form-check-label ms-1" for="grade_8">8</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="9" id="grade_9"><label class="form-check-label ms-1" for="grade_9">9</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="10" id="grade_10"><label class="form-check-label ms-1" for="grade_10">10</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="11" id="grade_11"><label class="form-check-label ms-1" for="grade_11">11</label></div>
                  <div class="col-auto"><input type="checkbox" class="form-check-input" value="12" id="grade_12"><label class="form-check-label ms-1" for="grade_12">12</label></div>
                </div>
              </div>
              
              <!-- Grade Range Selection -->
              <div id="gradeRangeSection" class="mt-3" style="display: none;">
                <div class="row g-2">
                  <div class="col-md-3">
                    <label for="minGrade" class="form-label">From Grade:</label>
                    <select id="minGrade" class="form-select">
                      <option value="0">Kindergarten</option>
                      <option value="1">Grade 1</option>
                      <option value="2">Grade 2</option>
                      <option value="3">Grade 3</option>
                      <option value="4">Grade 4</option>
                      <option value="5">Grade 5</option>
                      <option value="6">Grade 6</option>
                      <option value="7">Grade 7</option>
                      <option value="8">Grade 8</option>
                      <option value="9">Grade 9</option>
                      <option value="10">Grade 10</option>
                      <option value="11">Grade 11</option>
                      <option value="12">Grade 12</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="maxGrade" class="form-label">To Grade:</label>
                    <select id="maxGrade" class="form-select">
                      <option value="0">Kindergarten</option>
                      <option value="1">Grade 1</option>
                      <option value="2">Grade 2</option>
                      <option value="3">Grade 3</option>
                      <option value="4">Grade 4</option>
                      <option value="5">Grade 5</option>
                      <option value="6">Grade 6</option>
                      <option value="7">Grade 7</option>
                      <option value="8">Grade 8</option>
                      <option value="9">Grade 9</option>
                      <option value="10">Grade 10</option>
                      <option value="11">Grade 11</option>
                      <option value="12">Grade 12</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Clustering-specific parameters -->
            <div id="clusteringParameters">
              <!-- For Atoms/Standards clustering -->
              <div id="clusteringConfig" class="row g-3">
                <div class="col-md-4">
                  <label for="min_cluster" class="form-label">Min group size</label>
                  <input type="number" id="min_cluster" class="form-control" value="8" min="2">
                  <div class="form-text">Higher = fewer, bigger groups. Lower = more, smaller groups.</div>
                </div>
                <div class="col-md-4">
                  <label for="epsilon" class="form-label">Merge sensitivity (epsilon)</label>
                  <input type="number" id="epsilon" class="form-control" step="0.01" value="0.15">
                  <div class="form-text">Higher merges more; lower keeps groups separate. Try 0.10–0.25.</div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="name_proxies">
                    <label class="form-check-label" for="name_proxies">
                      Name Common Standards after creation
                    </label>
                    <div class="form-text">Writes short, human‑friendly titles and one‑sentence descriptions using AI (requires OpenAI key).</div>
                  </div>
                </div>
              </div>
              
              <!-- For Topic categorization -->
              <div id="topicConfig" class="row g-3" style="display: none;">
                <div class="col-md-4">
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="use_dynamic_chunk" checked>
                    <label class="form-check-label" for="use_dynamic_chunk">
                      Dynamic chunk sizing (recommended)
                    </label>
                  </div>
                  <label for="chunk_size" class="form-label">Chunk size</label>
                  <input type="number" id="chunk_size" class="form-control" value="25" min="5" max="500" disabled>
                  <div class="form-text" id="chunk_help_text">Dynamic sizing automatically optimizes for context window.</div>
                </div>
                <div class="col-md-4">
                  <label for="subject_area" class="form-label">Subject area focus (optional)</label>
                  <select id="subject_area" class="form-select">
                    <option value="">All subject areas</option>
                    {% for subject in subject_areas %}
                    <option value="{{ subject.id }}">{{ subject.name }} ({{ subject.standards_count }} standards)</option>
                    {% endfor %}
                  </select>
                  <div class="form-text">Focus topic generation on specific subject area.</div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="include_outliers" checked>
                    <label class="form-check-label" for="include_outliers">
                      Include outlier categories
                    </label>
                    <div class="form-text">Create categories for standards that don't fit the main taxonomy.</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">Create</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Prepare Data</h5>
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label for="state_filter" class="form-label">State filter (optional)</label>
              <input type="text" id="state_filter" class="form-control" placeholder="e.g., CA">
            </div>
            <div class="col-md-3">
              <label for="limit" class="form-label">Limit (optional)</label>
              <input type="number" id="limit" class="form-control" min="0" placeholder="0 = all">
            </div>
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="use_gpt">
                <label class="form-check-label" for="use_gpt">Use GPT to assist atomization</label>
              </div>
            </div>
            <div class="col-md-3">
              <button id="btn-atomize" class="btn btn-outline-primary w-100" type="button">Atomize Standards</button>
            </div>
            <div class="col-md-3">
              <button id="btn-embed-atoms" class="btn btn-outline-secondary w-100" type="button">Generate Atom Embeddings</button>
            </div>
            <div class="col-md-3">
              <button id="btn-run-pipeline" class="btn btn-success w-100" type="button">Run Full Pipeline</button>
            </div>
          </div>
        </div>
      </div>

      <div id="status" class="alert alert-secondary d-none" role="alert"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form = document.getElementById('proxy-form');
  const statusDiv = document.getElementById('status');
  let pollTimer = null;

  function showStatus(text, cls) {
    statusDiv.className = 'alert ' + (cls || 'alert-info');
    statusDiv.textContent = text;
    statusDiv.classList.remove('d-none');
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  async function postJson(url, payload) {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') || ''},
      body: JSON.stringify(payload || {})
    });
    let data;
    try { data = await resp.json(); } catch (e) { data = { error: 'Invalid server response' }; }
    if (!resp.ok) throw new Error(data.error || 'Request failed');
    return data;
  }

  async function validateTopicCombination(payload) {
    // Build validation query parameters
    let validationParams = new URLSearchParams();
    
    if (payload.grade_selection && payload.grade_selection.type === 'specific' && payload.grade_selection.grades) {
      validationParams.append('grade_levels', payload.grade_selection.grades.join(','));
    } else if (payload.grade_selection && payload.grade_selection.type === 'range') {
      const grades = [];
      for (let g = payload.grade_selection.min_grade; g <= payload.grade_selection.max_grade; g++) {
        grades.push(g);
      }
      validationParams.append('grade_levels', grades.join(','));
    }
    
    if (payload.subject_area_id) {
      validationParams.append('subject_area_id', payload.subject_area_id);
    }
    
    try {
      const resp = await fetch(`{% url 'dashboard:validate_topic_criteria' %}?${validationParams.toString()}`);
      
      if (!resp.ok) {
        console.warn('Validation endpoint not available, proceeding without validation');
        return; // Allow form submission to proceed
      }
      
      const data = await resp.json();
      
      if (!data.valid) {
        throw new Error(`Cannot generate topics: ${data.error}`);
      }
      
      showStatus(`✓ Found ${data.standards_count} standards for topic generation`, 'alert-success');
      
    } catch (error) {
      // If validation fails for any reason, still show the error but allow submission
      if (error.message.includes('Cannot generate topics:')) {
        throw error; // Re-throw validation errors to prevent submission
      } else {
        console.warn('Validation check failed, proceeding anyway:', error);
        // Allow form submission to proceed for technical errors
      }
    }
  }
  // Handle grade selection type changes
  document.querySelectorAll('.grade-type-radio').forEach(radio => {
    radio.addEventListener('change', function() {
      document.getElementById('specificGradesSection').style.display = this.value === 'specific' ? 'block' : 'none';
      document.getElementById('gradeRangeSection').style.display = this.value === 'range' ? 'block' : 'none';
    });
  });
  
  // Handle clustering type changes
  document.querySelectorAll('.clustering-type-radio').forEach(radio => {
    radio.addEventListener('change', function() {
      const clusteringConfig = document.getElementById('clusteringConfig');
      const topicConfig = document.getElementById('topicConfig');
      
      if (this.value === 'topics') {
        clusteringConfig.style.display = 'none';
        topicConfig.style.display = 'block';
      } else {
        clusteringConfig.style.display = 'block';
        topicConfig.style.display = 'none';
      }
    });
  });
  
  // Handle dynamic chunk size toggle
  document.getElementById('use_dynamic_chunk').addEventListener('change', function(e) {
    const chunkInput = document.getElementById('chunk_size');
    const helpText = document.getElementById('chunk_help_text');
    
    if (e.target.checked) {
      chunkInput.disabled = true;
      helpText.textContent = 'Dynamic sizing automatically optimizes for context window.';
    } else {
      chunkInput.disabled = false;
      helpText.textContent = 'Standards per AI call. Lower = more accurate, higher = faster.';
    }
  });
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      clearInterval(pollTimer);
      showStatus('Starting...', 'alert-secondary');
      
      // Determine clustering type first
      const clusteringType = document.querySelector('input[name="clusteringType"]:checked').value;
      
      // Build payload based on clustering type
      let payload = {};
      let apiUrl, jobType;
      
      if (clusteringType === 'topics') {
        // Topic categorization payload
        const useDynamicChunk = document.getElementById('use_dynamic_chunk').checked;
        payload = {
          use_dynamic_chunk: useDynamicChunk,
          chunk_size: useDynamicChunk ? null : Number(document.getElementById('chunk_size').value || 25),
          include_outliers: document.getElementById('include_outliers').checked
        };
        
        // Add subject area if selected
        const subjectAreaValue = document.getElementById('subject_area').value;
        if (subjectAreaValue) {
          payload.subject_area_id = parseInt(subjectAreaValue);
        }
        
        apiUrl = "{% url 'dashboard:generate_topic_proxies_api' %}";
        jobType = 'topic_proxy_job';
        
        // Validate the combination has standards before submitting (optional)
        try {
          await validateTopicCombination(payload);
        } catch (validationError) {
          // If validation fails, show error and don't submit
          throw validationError;
        }
      } else {
        // Traditional clustering payload
        payload = {
          min_cluster: Number(document.getElementById('min_cluster').value || 8),
          epsilon: Number(document.getElementById('epsilon').value || 0.15),
          name_proxies: document.getElementById('name_proxies').checked
        };
        
        if (clusteringType === 'standards') {
          apiUrl = "{% url 'dashboard:generate_standard_proxies_api' %}";
          jobType = 'standard_proxy_job';
        } else {
          apiUrl = "{% url 'dashboard:generate_proxies_api' %}";
          jobType = 'proxy_job';
        }
      }
      
      // Add grade selection to payload (common for all types)
      const gradeType = document.querySelector('input[name="gradeSelectionType"]:checked').value;
      if (gradeType === 'specific') {
        const selectedGrades = [];
        document.querySelectorAll('#specificGradesSection input[type="checkbox"]:checked').forEach(cb => {
          selectedGrades.push(parseInt(cb.value));
        });
        if (selectedGrades.length > 0) {
          payload.grade_selection = {
            type: 'specific',
            grades: selectedGrades
          };
        }
      } else if (gradeType === 'range') {
        payload.grade_selection = {
          type: 'range',
          min_grade: parseInt(document.getElementById('minGrade').value),
          max_grade: parseInt(document.getElementById('maxGrade').value)
        };
      }
      
      const { job_id } = await postJson(apiUrl, payload);
      showStatus(`Queued (job ${job_id})...`, 'alert-secondary');
      pollTimer = setInterval(async () => {
        try {
          // Use appropriate status endpoint based on clustering type
          let statusUrl;
          if (clusteringType === 'topics') {
            statusUrl = "{% url 'dashboard:topic_proxy_job_status_api' job_id='JOB' %}".replace('JOB', job_id);
          } else if (clusteringType === 'standards') {
            statusUrl = "{% url 'dashboard:standard_proxy_job_status_api' job_id='JOB' %}".replace('JOB', job_id);
          } else {
            statusUrl = "{% url 'dashboard:proxy_job_status_api' job_id='JOB' %}".replace('JOB', job_id);
          }
          const r = await fetch(statusUrl);
          let s; try { s = await r.json(); } catch (e) { s = { error: 'Invalid server response' }; }
          if (!r.ok) throw new Error(s.error || 'Request failed');
          let statusMessage = `${s.status} — ${s.progress}% — ${s.message}`;
          if (s.status === 'completed' && s.run_id) {
            statusMessage += ` <a href="/dashboard/proxy-runs/?run_id=${s.run_id}" class="btn btn-sm btn-outline-primary ms-2">View Analysis →</a>`;
          }
          statusDiv.innerHTML = statusMessage;
          statusDiv.className = 'alert ' + (s.status === 'failed' ? 'alert-danger' : (s.status === 'completed' ? 'alert-success' : 'alert-secondary'));
          statusDiv.classList.remove('d-none');
          if (s.status === 'completed' || s.status === 'failed') clearInterval(pollTimer);
        } catch (err) {
          clearInterval(pollTimer);
          showStatus('Error: ' + err.message, 'alert-danger');
        }
      }, 1000);
    } catch (err) {
      showStatus('Error: ' + err.message, 'alert-danger');
    }
  });

  function startPolling(urlBuilder, startedMsg) {
    clearInterval(pollTimer);
    showStatus(startedMsg || 'Started...', 'alert-secondary');
    return (jobId) => {
      pollTimer = setInterval(async () => {
        const r = await fetch(urlBuilder(jobId));
        const s = await r.json();
        if (!r.ok) {
          clearInterval(pollTimer);
          showStatus('Error: ' + (s.error || 'failed'), 'alert-danger');
          return;
        }
        let statusMessage = `${s.status} — ${s.progress}% — ${s.message}`;
        if (s.status === 'completed' && s.run_id) {
          statusMessage += ` <a href="/dashboard/proxy-runs/?run_id=${s.run_id}" class="btn btn-sm btn-outline-primary ms-2">View Analysis →</a>`;
        }
        statusDiv.innerHTML = statusMessage;
        statusDiv.className = 'alert ' + (s.status === 'failed' ? 'alert-danger' : (s.status === 'completed' ? 'alert-success' : 'alert-secondary'));
        statusDiv.classList.remove('d-none');
        if (s.status === 'completed' || s.status === 'failed') {
          clearInterval(pollTimer);
        }
      }, 1000);
    };
  }

  document.getElementById('btn-atomize').addEventListener('click', async () => {
    try {
      const payload = {
        state: document.getElementById('state_filter').value || null,
        use_gpt: document.getElementById('use_gpt').checked,
        limit: Number(document.getElementById('limit').value || 0)
      };
      const { job_id } = await postJson("{% url 'dashboard:atomize_standards_api' %}", payload);
      const poll = startPolling((id) => "{% url 'dashboard:atomize_job_status_api' job_id='JOB' %}".replace('JOB', id), 'Atomization started...');
      poll(job_id);
    } catch (e) {
      showStatus('Error: ' + e.message, 'alert-danger');
    }
  });

  document.getElementById('btn-embed-atoms').addEventListener('click', async () => {
    try {
      const payload = { state: document.getElementById('state_filter').value || null };
      const { job_id } = await postJson("{% url 'dashboard:generate_atom_embeddings_api' %}", payload);
      const poll = startPolling((id) => "{% url 'dashboard:atom_embeddings_job_status_api' job_id='JOB' %}".replace('JOB', id), 'Generating atom embeddings...');
      poll(job_id);
    } catch (e) {
      showStatus('Error: ' + e.message, 'alert-danger');
    }
  });

  document.getElementById('btn-run-pipeline').addEventListener('click', async () => {
    try {
      const payload = {
        state: document.getElementById('state_filter').value || null,
        use_gpt: document.getElementById('use_gpt').checked,
        limit: Number(document.getElementById('limit').value || 0),
        min_cluster: Number(document.getElementById('min_cluster').value || 8),
        epsilon: Number(document.getElementById('epsilon').value || 0.15),
        name_proxies: document.getElementById('name_proxies').checked,
        batch_size: 100
      };
      
      // Add grade selection to pipeline payload
      const gradeType = document.querySelector('input[name="gradeSelectionType"]:checked').value;
      if (gradeType === 'specific') {
        const selectedGrades = [];
        document.querySelectorAll('#specificGradesSection input[type="checkbox"]:checked').forEach(cb => {
          selectedGrades.push(parseInt(cb.value));
        });
        if (selectedGrades.length > 0) {
          payload.grade_selection = {
            type: 'specific',
            grades: selectedGrades
          };
        }
      } else if (gradeType === 'range') {
        payload.grade_selection = {
          type: 'range',
          min_grade: parseInt(document.getElementById('minGrade').value),
          max_grade: parseInt(document.getElementById('maxGrade').value)
        };
      }
      
      const { job_id } = await postJson("{% url 'dashboard:run_proxy_pipeline_api' %}", payload);
      const poll = startPolling((id) => "{% url 'dashboard:proxy_pipeline_status_api' job_id='JOB' %}".replace('JOB', id), 'Pipeline started...');
      poll(job_id);
    } catch (e) {
      showStatus('Error: ' + e.message, 'alert-danger');
    }
  });
})();
</script>
{% endblock %}
