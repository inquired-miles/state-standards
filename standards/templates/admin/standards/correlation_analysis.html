{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}Correlation Threshold Analysis{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .analysis-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .analysis-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .current-distribution {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .distribution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .distribution-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .distribution-count {
            font-size: 1.5em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 5px;
        }
        .distribution-range {
            font-size: 0.8em;
            color: #666;
        }
        .analysis-form {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .form-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        .form-group .help-text {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }
        .analyze-button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 0;
        }
        .analyze-button:hover {
            background: #0052a3;
        }
        .analyze-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .results-table th,
        .results-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .results-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        .results-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .quality-high { color: #27ae60; font-weight: bold; }
        .quality-medium { color: #f39c12; font-weight: bold; }
        .quality-low { color: #e74c3c; font-weight: bold; }
        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .summary-item {
            text-align: center;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 5px;
            border: 1px solid #bee5eb;
        }
        .summary-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 5px;
        }
        .summary-label {
            font-size: 0.8em;
            color: #666;
        }
        .recommendation-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .recommendation-title {
            font-weight: bold;
            color: #0c5460;
            margin-bottom: 10px;
        }
    </style>
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let analysisChart;
        
        function performAnalysis() {
            const form = document.getElementById('analysis-form');
            const formData = new FormData(form);
            const button = document.getElementById('analyze-button');
            const loading = document.getElementById('loading-spinner');
            const results = document.getElementById('results-section');
            
            // Show loading state
            button.disabled = true;
            button.textContent = 'Analyzing...';
            loading.style.display = 'block';
            results.style.display = 'none';
            
            fetch('{% url "admin_correlation_analysis" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    displayResults(data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error performing analysis: ' + error);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Run Analysis';
                loading.style.display = 'none';
            });
        }
        
        function displayResults(data) {
            const results = document.getElementById('results-section');
            const tbody = document.getElementById('results-tbody');
            const summary = document.getElementById('summary-stats');
            
            // Clear previous results
            tbody.innerHTML = '';
            
            // Populate results table
            data.analysis_results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.threshold}</td>
                    <td>${result.avg_correlations_per_standard}</td>
                    <td>${result.estimated_total_correlations}</td>
                    <td class="quality-${result.quality_info.quality}">${result.quality_info.quality.toUpperCase()}</td>
                    <td><small>${result.quality_info.description}</small></td>
                `;
                tbody.appendChild(row);
            });
            
            // Update summary statistics
            const bestThreshold = findOptimalThreshold(data.analysis_results);
            summary.innerHTML = `
                <div class="summary-item">
                    <div class="summary-value">${data.sample_size}</div>
                    <div class="summary-label">Sample Size</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${data.total_standards}</div>
                    <div class="summary-label">Total Standards</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${bestThreshold.threshold}</div>
                    <div class="summary-label">Recommended Threshold</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${bestThreshold.estimated_total_correlations}</div>
                    <div class="summary-label">Est. Correlations</div>
                </div>
            `;
            
            // Update chart
            updateChart(data.analysis_results);
            
            // Show recommendation
            updateRecommendation(bestThreshold);
            
            // Show results
            results.style.display = 'block';
        }
        
        function findOptimalThreshold(results) {
            // Find threshold with high quality and reasonable correlation count
            const highQuality = results.filter(r => r.quality_info.quality === 'high');
            if (highQuality.length > 0) {
                return highQuality[0]; // First high quality threshold
            }
            
            const mediumQuality = results.filter(r => r.quality_info.quality === 'medium');
            if (mediumQuality.length > 0) {
                return mediumQuality[0]; // First medium quality threshold
            }
            
            return results[0]; // Fallback to first result
        }
        
        function updateChart(data) {
            const ctx = document.getElementById('analysis-chart').getContext('2d');
            
            if (analysisChart) {
                analysisChart.destroy();
            }
            
            analysisChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.threshold),
                    datasets: [
                        {
                            label: 'Avg Correlations per Standard',
                            data: data.map(d => d.avg_correlations_per_standard),
                            borderColor: '#0066cc',
                            backgroundColor: 'rgba(0, 102, 204, 0.1)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Total Estimated Correlations',
                            data: data.map(d => d.estimated_total_correlations / 1000), // Scale down for display
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Similarity Threshold'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Avg Correlations per Standard'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Total Correlations (thousands)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: 'Correlation Count vs Threshold'
                        }
                    }
                }
            });
        }
        
        function updateRecommendation(bestThreshold) {
            const recommendation = document.getElementById('recommendation');
            recommendation.innerHTML = `
                <div class="recommendation-title">💡 Recommendation</div>
                <p><strong>Optimal Threshold: ${bestThreshold.threshold}</strong></p>
                <p>${bestThreshold.quality_info.description}</p>
                <p>This threshold will generate approximately <strong>${bestThreshold.estimated_total_correlations} correlations</strong> 
                with <strong>${bestThreshold.quality_info.quality}</strong> quality matches.</p>
                <p><a href="{% url 'admin_generate_correlations' %}?threshold=${bestThreshold.threshold}" class="button">
                Use This Threshold →</a></p>
            `;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set up form submission
            document.getElementById('analyze-button').addEventListener('click', performAnalysis);
            
            // Prevent form submission on enter
            document.getElementById('analysis-form').addEventListener('submit', function(e) {
                e.preventDefault();
                performAnalysis();
            });
        });
    </script>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <div class="analysis-header">
        <h1>Correlation Threshold Analysis</h1>
        <p>Analyze how different similarity thresholds affect correlation generation</p>
    </div>
    
    <div class="current-distribution">
        <h2>Current Correlation Distribution</h2>
        {% if distribution_data.total_correlations > 0 %}
        <div class="summary-stats">
            <div class="summary-item">
                <div class="summary-value">{{ distribution_data.total_correlations }}</div>
                <div class="summary-label">Total Correlations</div>
            </div>
            <div class="summary-item">
                <div class="summary-value">{{ distribution_data.average_score|floatformat:2 }}</div>
                <div class="summary-label">Average Score</div>
            </div>
            <div class="summary-item">
                <div class="summary-value">{{ distribution_data.median_score|floatformat:2 }}</div>
                <div class="summary-label">Median Score</div>
            </div>
        </div>
        
        <h3>Score Distribution</h3>
        <div class="distribution-grid">
            {% for item in distribution_data.histogram %}
            <div class="distribution-item">
                <div class="distribution-count">{{ item.count }}</div>
                <div class="distribution-range">{{ item.range }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No correlations found. Generate some correlations first to see distribution data.</p>
        {% endif %}
    </div>
    
    <div class="analysis-form">
        <h2>Threshold Analysis Parameters</h2>
        <form id="analysis-form">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label for="{{ form.min_threshold.id_for_label }}">{{ form.min_threshold.label }}</label>
                    {{ form.min_threshold }}
                    <div class="help-text">{{ form.min_threshold.help_text }}</div>
                </div>
                <div class="form-group">
                    <label for="{{ form.max_threshold.id_for_label }}">{{ form.max_threshold.label }}</label>
                    {{ form.max_threshold }}
                    <div class="help-text">{{ form.max_threshold.help_text }}</div>
                </div>
                <div class="form-group">
                    <label for="{{ form.step_size.id_for_label }}">{{ form.step_size.label }}</label>
                    {{ form.step_size }}
                    <div class="help-text">{{ form.step_size.help_text }}</div>
                </div>
                <div class="form-group">
                    <label for="{{ form.sample_size.id_for_label }}">{{ form.sample_size.label }}</label>
                    {{ form.sample_size }}
                    <div class="help-text">{{ form.sample_size.help_text }}</div>
                </div>
            </div>
            
            <button type="button" id="analyze-button" class="analyze-button">
                Run Analysis
            </button>
        </form>
        
        <div id="loading-spinner" class="loading-spinner">
            <p>🔄 Analyzing thresholds... This may take a few moments.</p>
        </div>
    </div>
    
    <div id="results-section" class="results-section">
        <h2>Analysis Results</h2>
        
        <div id="summary-stats" class="summary-stats">
            <!-- Summary statistics will be populated here -->
        </div>
        
        <div class="chart-container">
            <canvas id="analysis-chart"></canvas>
        </div>
        
        <table class="results-table">
            <thead>
                <tr>
                    <th>Threshold</th>
                    <th>Avg Correlations per Standard</th>
                    <th>Estimated Total Correlations</th>
                    <th>Quality</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody id="results-tbody">
                <!-- Results will be populated here -->
            </tbody>
        </table>
        
        <div id="recommendation" class="recommendation-box">
            <!-- Recommendation will be populated here -->
        </div>
    </div>
    
    <div style="text-align: center; margin: 30px 0;">
        <a href="{% url 'admin_generate_correlations' %}" class="button">← Back to Correlation Generator</a>
        <a href="{% url 'admin:standards_standardcorrelation_changelist' %}" class="button">View Existing Correlations</a>
    </div>
</div>
{% endblock %}